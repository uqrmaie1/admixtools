<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADMIXTOOLS 2 torial • admixtools</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><script src="../extra.js"></script><meta property="og:title" content="ADMIXTOOLS 2 torial">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-155330476-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-155330476-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">admixtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/admixtools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/fstats.html">Computing *f*-statistics</a>
    </li>
    <li>
      <a href="../articles/plotting.html">Plotting</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="admixtools_files/htmlwidgets-1.3/htmlwidgets.js"></script><script src="admixtools_files/plotly-binding-4.9.1/plotly.js"></script><script src="admixtools_files/typedarray-0.1/typedarray.min.js"></script><script src="admixtools_files/jquery-1.11.3/jquery.min.js"></script><link href="admixtools_files/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet">
<script src="admixtools_files/crosstalk-1.0.0/js/crosstalk.min.js"></script><link href="admixtools_files/plotly-htmlwidgets-css-1.49.4/plotly-htmlwidgets.css" rel="stylesheet">
<script src="admixtools_files/plotly-main-1.49.4/plotly-latest.min.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>ADMIXTOOLS 2 torial</h1>
            
      
      
      <div class="hidden name"><code>admixtools.Rmd</code></div>

    </div>

    
    
<p>This tutorial gives an overview of the basic workflow for computing f-statistics, and using <em>qpWave</em>, <em>qpAdm</em>, and <em>qpGraph</em>. Documentation for each ADMIXTOOLS function can be found under <em>Reference</em>, and more detailed information about specific topics under <em>Articles</em>.</p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Admixtools is a set of programs used to infer population histories from f-statistics computed from genetic data. ADMIXTOOLS 2 divides the computation into two steps: 1. Computing f2-statistics and storing them on disk This can be slow since it accesses the genotype data 2. Using f2-statistics to fit models This is fast because f2-statistics are very compact compared to genotype data</p>
<p>ADMIXTOOLS 2 can either be run through the <code>R</code> command line, or through a browser application that can be launched like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(admixtools)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">run_shiny_admixtools</span>()</a></code></pre></div>
<p>The documentation of the browser application can be accessed through the <code>?</code> in the upper right corner of the application window. This website documents the <code>R</code> command line interface.</p>
<p>For the examples below the following R packages need to be loaded.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(admixtools)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)</a></code></pre></div>
<p><br></p>
</div>
<div id="f-statistics" class="section level2">
<h2 class="hasAnchor">
<a href="#f-statistics" class="anchor"></a><em>f</em>-statistics</h2>
<p><span class="math inline">\(f_2\)</span>, <span class="math inline">\(f_3\)</span>, and <span class="math inline">\(f_4\)</span> describe how populations are related to one another, and they form the basis of ADMIXTOOLS. Here we briefly describe what they are and how to compute them. Two excellent papers on f-statistics can be found <a href="https://www.genetics.org/content/192/3/1065">here</a> and <a href="https://www.genetics.org/content/202/4/1485">here</a>.</p>
<p><span class="math inline">\(f_2\)</span> is the expected squared difference in allele frequencies between two populations <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span>. (Allele frequencies are denoted in lower case letters here.) We can estimate it by averaging over <span class="math inline">\(n\)</span> SNPs: <span class="math display">\[f_2(A,B) = \frac{1}{n} \sum_{j=1}^n(a_{j} - b_{j})^2\]</span></p>
<p><span class="math inline">\(f_4\)</span> is the covariance of allele frequency differences between two pairs of populations, and at the same time the sum of four f2-statistics: <span class="math display">\[
\begin{equation}
\begin{aligned}
f_4(A, B; C, D) &amp;= \frac{1}{n}\sum_{j=1}^n(a_{j} - b_{j})(c_{j} - d_{j}) \\ &amp;= \frac{1}{2}(f_2(A, D) + f_2(B, C) - f_2(A, C) - f_2(B, D) )
\label{eq:f42}
\end{aligned}
\end{equation}
\]</span></p>
<p><span class="math inline">\(f_3\)</span> is the covariance of allele frequency differences between two pairs of populations where one population is the same on both sides. <span class="math inline">\(f_3\)</span> is thus a special case of <span class="math inline">\(f_4\)</span>, and can also be written as a sum of <span class="math inline">\(f_2\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
f_3(A; B, C) &amp;= f_4(A, B; A, C) \\ &amp;= \frac{1}{2} (f_2(A, B) + f_2(A, C) - f_2(B, C))
\end{aligned}
\]</span></p>
<p>In practice, the estimation of f-statistics can be more complicated, as it needs to account for low sample counts, missing data, and differences in ploidy, as described <a href="fstats.Rmd">here</a>.</p>
<p>In ADMIXTOOLS 2, extracting f2-statistics from genotype data is the foundation for all further analyses:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">prefix =<span class="st"> '/path/to/geno'</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">my_f2_dir =<span class="st"> '/store/f2data/here/'</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw"><a href="../reference/extract_f2.html">extract_f2</a></span>(prefix, my_f2_dir)</a></code></pre></div>
<p>This will look for genotype files in <code>packedancestrymap</code> or <code>PLINK</code> format, compute allele frequencies and blocked f2 statistics for all pairs of populations defined in the <code>.ind</code> or <code>.fam</code> file, and write them to <code>my_f2_dir</code>. It is also possible to extract only a subset of the samples or populations by passing IDs to the <code>inds</code> and <code>pops</code> arguments in <code>extract_f2</code>. To get a description of the arguemnts and to see examples of how to use it, type</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">?extract_f2</a></code></pre></div>
<p>Once finished, f2-statistics for the populations of interest can be loaded like this.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">f2_blocks =<span class="st"> </span><span class="kw"><a href="../reference/f2_from_precomp.html">f2_from_precomp</a></span>(my_f2_dir)</a></code></pre></div>
<p>Or you can load only a subset of the populations:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">mypops =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Denisova.DG'</span>, <span class="st">'Altai_Neanderthal.DG'</span>, <span class="st">'Vindija.DG'</span>)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">f2_blocks =<span class="st"> </span><span class="kw"><a href="../reference/f2_from_precomp.html">f2_from_precomp</a></span>(my_f2_dir, <span class="dt">pops =</span> mypops)</a></code></pre></div>
<p><code>f2_blocks</code> is now a 3d-array with f2-statistics for each population pair (along dimensions 1 and 2) and each SNP block (along the 3rd dimension).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(f2_blocks)</a></code></pre></div>
<pre><code>## [1]   7   7 708</code></pre>
<p>Separate estimates for each SNP block make it possible to compute jackknife or bootstrap standard errors for any f-statistic, and for any other estimated parameter.</p>
<p><code>f2_blocks</code> can be used like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">f2_blocks[,,<span class="dv">1</span>]                <span class="co"># f2-statistics of the 1st SNP block</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(f2_blocks, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, mean)   <span class="co"># average across all blocks</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">f2_blocks[pop1, pop2, ]       <span class="co"># f2(pop1, pop2) for all blocks</span></a></code></pre></div>
<p>The names along the 3rd dimension contain the SNP block lengths:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">block_lengths =<span class="st"> </span><span class="kw">parse_number</span>(<span class="kw"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span>(f2_blocks)[[<span class="dv">3</span>]])</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(block_lengths)</a></code></pre></div>
<pre><code>## [1] 424 772 795 835 574 842</code></pre>
<p>If you want to try any of this without extracting and loading your own f2-statistics, you can instead use <code>example_f2_blocks</code> which becomes available as you load <code>admixtools</code>.</p>
<p><br></p>
</div>
<div id="qp3pop" class="section level2">
<h2 class="hasAnchor">
<a href="#qp3pop" class="anchor"></a>qp3Pop</h2>
<p>The original ADMIXTOOLS program for computing f3-statistics is called <em>qp3Pop</em>. In ADMIXTOOLS 2, you can compute f3-statistics like this:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">pop1 =<span class="st"> 'Denisova.DG'</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">pop2 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Altai_Neanderthal.DG'</span>, <span class="st">'Vindija.DG'</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">pop3 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Chimp.REF'</span>, <span class="st">'Mbuti.DG'</span>, <span class="st">'Russia_Ust_Ishim.DG'</span>)</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="../reference/qp3pop.html">qp3pop</a></span>(f2_blocks, pop1, pop2, pop3)</a></code></pre></div>
<p>Or, equivalently</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="../reference/qp3pop.html">f3</a></span>(f2_blocks, pop1, pop2, pop3)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##   pop1        pop2                 pop3                  est      se     z     p
##   &lt;chr&gt;       &lt;chr&gt;                &lt;chr&gt;               &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 Denisova.DG Altai_Neanderthal.DG Chimp.REF          0.0591 5.98e-4  98.7     0
## 2 Denisova.DG Altai_Neanderthal.DG Mbuti.DG           0.0720 6.47e-4 111.      0
## 3 Denisova.DG Altai_Neanderthal.DG Russia_Ust_Ishim.… 0.0742 7.02e-4 106.      0
## 4 Denisova.DG Vindija.DG           Chimp.REF          0.0594 5.92e-4 100.      0
## 5 Denisova.DG Vindija.DG           Mbuti.DG           0.0724 6.34e-4 114.      0
## 6 Denisova.DG Vindija.DG           Russia_Ust_Ishim.… 0.0750 6.96e-4 108.      0</code></pre>
<p>This will compute f3-statistics for all combinations of <code>pop1</code>, <code>pop2</code>, and <code>pop3</code>. Typing just <code><a href="../reference/qp3pop.html">f3(f2_blocks)</a></code> will compute all possible combinations (which can be a large number). If only <code>pop1</code> is supplied, all combinations of populations in <code>pop1</code> will be computed.</p>
<p><br></p>
</div>
<div id="qpdstat" class="section level2">
<h2 class="hasAnchor">
<a href="#qpdstat" class="anchor"></a>qpDstat</h2>
<p>The original ADMIXTOOLS program for computing f4-statistics is called <em>qpDstat</em>. As the name suggests, it computes <em>D</em>-statistics by default. To get f4-statistics instead, the <code>f4mode</code> argument needs to set to <code>YES</code>. In ADMIXTOOLS 2, almost everything starts with f2-statistics, so the <code>qpdstat</code>/<code>f4</code> function computes f4-statistics by default.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">pop4 =<span class="st"> 'Switzerland_Bichon.SG'</span></a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw"><a href="../reference/qpdstat.html">f4</a></span>(f2_blocks, pop1, pop2, pop3, pop4)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw"><a href="../reference/qpdstat.html">qpdstat</a></span>(f2_blocks, pop1, pop2, pop3, pop4)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="co"># two names for the same function</span></a></code></pre></div>
<pre><code>## ℹ Getting population combinations...
## ℹ 6 population combinations found
## ℹ Loading f2 data for 12 population pairs...
## ℹ Computing f4-statistics</code></pre>
<pre><code>## # A tibble: 6 x 8
##   pop1     pop2        pop3        pop4             est      se      z         p
##   &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
## 1 Denisov… Altai_Nean… Chimp.REF   Switzerlan…  1.50e-2 4.64e-4 32.3   6.06e-229
## 2 Denisov… Altai_Nean… Mbuti.DG    Switzerlan…  2.03e-3 3.53e-4  5.75  8.85e-  9
## 3 Denisov… Altai_Nean… Russia_Ust… Switzerlan… -2.17e-4 3.73e-4 -0.580 5.62e-  1
## 4 Denisov… Vindija.DG  Chimp.REF   Switzerlan…  1.54e-2 4.78e-4 32.2   5.81e-228
## 5 Denisov… Vindija.DG  Mbuti.DG    Switzerlan…  2.33e-3 3.63e-4  6.42  1.40e- 10
## 6 Denisov… Vindija.DG  Russia_Ust… Switzerlan… -2.40e-4 3.87e-4 -0.620 5.35e-  1</code></pre>
<p>The differences between f4-statistics and D-statistics are usually negligible. However, it is still possible to compute D-statistics in ADMIXTOOLS 2, by providing genotype data as the first argument, and setting <code>f4mode = FALSE</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">prefix =<span class="st"> '/path/to/geno'</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="kw"><a href="../reference/qpdstat.html">f4</a></span>(prefix, pop1, pop2, pop3, pop4, <span class="dt">f4mode =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>Computing f4- or D-statistics from genotype data directly is slower, but it has the advantage that it avoids any problems that may arise from large amounts of missing data. More on this <a href="fstats.Rmd">here</a>.</p>
<p><br></p>
</div>
<div id="qpwave-and-qpadm" class="section level2">
<h2 class="hasAnchor">
<a href="#qpwave-and-qpadm" class="anchor"></a>qpWave and qpAdm</h2>
<p>qpWave and qpAdm are two programs with diffent goals - one estimates the number of admixture events, the other admixture weights - but they perform the same computations. In ADMIXTOOLS 2, <code>qpadm</code> and <code>qpwave</code> are two names for one function. This function requires three arguments: 1. f2-statistics 2. A set of left populations 3. A set of right populations A target population, which will be modelled as a mixture of left populations, can be provided as the 4th argument.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">left =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Altai_Neanderthal.DG'</span>, <span class="st">'Vindija.DG'</span>)</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">right =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Chimp.REF'</span>, <span class="st">'Mbuti.DG'</span>, <span class="st">'Russia_Ust_Ishim.DG'</span>, <span class="st">'Switzerland_Bichon.SG'</span>)</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">target =<span class="st"> 'Denisova.DG'</span></a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw"><a href="../reference/qpadm.html">qpadm</a></span>(f2_blocks, left, right, target)</a></code></pre></div>
<pre><code>## $weights
## # A tibble: 2 x 5
##   target      left                 weight    se     z
##   &lt;chr&gt;       &lt;chr&gt;                 &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 Denisova.DG Altai_Neanderthal.DG   49.6  23.3  2.13
## 2 Denisova.DG Vindija.DG            -48.6  23.3 -2.08
## 
## $f4
## # A tibble: 36 x 9
##    pop1    pop2       pop3   pop4           est      se       z         p weight
##    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;
##  1 Deniso… Altai_Nea… Chimp… Mbuti.DG   0.0129  3.64e-4  35.6   2.22e-277   49.6
##  2 Deniso… fit        Chimp… Mbuti.DG   0.00693 6.60e-3   1.05  2.94e-  1   NA  
##  3 Deniso… Vindija.DG Chimp… Mbuti.DG   0.0131  3.73e-4  35.0   7.55e-269  -48.6
##  4 Deniso… Altai_Nea… Chimp… Russia_U…  0.0152  4.46e-4  34.0   4.67e-254   49.6
##  5 Deniso… fit        Chimp… Russia_U… -0.00642 8.03e-3  -0.800 4.23e-  1   NA  
##  6 Deniso… Vindija.DG Chimp… Russia_U…  0.0156  4.53e-4  34.5   2.14e-261  -48.6
##  7 Deniso… Altai_Nea… Chimp… Switzerl…  0.0150  4.64e-4  32.3   6.06e-229   49.6
##  8 Deniso… fit        Chimp… Switzerl… -0.00552 8.43e-3  -0.654 5.13e-  1   NA  
##  9 Deniso… Vindija.DG Chimp… Switzerl…  0.0154  4.78e-4  32.2   5.81e-228  -48.6
## 10 Deniso… Altai_Nea… Mbuti… Chimp.REF -0.0129  3.64e-4 -35.6   2.22e-277   49.6
## # … with 26 more rows
## 
## $rankdrop
## # A tibble: 2 x 7
##   f4rank   dof   chisq      p dofdiff chisqdiff p_nested
## *  &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;int&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1      1     2    7.15 0.0280       4     1572.        0
## 2      0     6 1580.   0           NA       NA        NA
## 
## $popdrop
## # A tibble: 3 x 13
##   pat      wt   dof  chisq      p f4rank Altai_Neanderth… Vindija.DG feasible
##   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;            &lt;dbl&gt;      &lt;dbl&gt; &lt;lgl&gt;   
## 1 00        0     2 7.15e0 0.0280      1             49.6      -48.6 FALSE   
## 2 01        1     3 1.14e4 0           0              1         NA   TRUE    
## 3 10        1     3 1.14e4 0           0             NA          1   TRUE    
## # … with 4 more variables: best &lt;lgl&gt;, dofdiff &lt;dbl&gt;, chisqdiff &lt;dbl&gt;,
## #   p_nested &lt;dbl&gt;</code></pre>
<p>The output of <code>qpadm</code> is a list of four items:</p>
<ul>
<li>
<strong>weights</strong>: These are estimates of the relative contributions of the left population to the target population.</li>
<li>
<strong>f4</strong>: The estimated f4-statistics. If a target population is specified, this will include lines with fitted f4-statistics, where the target population is in the first column, and a weighted sum of the left populations, <code>fit</code>, in the second column.</li>
<li>
<strong>rankdrop</strong>: This shows how well the matrix of f4-statistics can be approximated when restricting the degrees of freedom (which is indicative of the number of admixture waves).</li>
<li>
<strong>popdrop</strong>: popdrop shows the fits of all models generated by dropping a specific subset of left populations, and will only be returned if a target population is specified.</li>
</ul>
<div id="ranks-and-degrees-of-freedom" class="section level3">
<h3 class="hasAnchor">
<a href="#ranks-and-degrees-of-freedom" class="anchor"></a>Ranks and degrees of freedom</h3>
</div>
<div id="pairwise-cladality-tests" class="section level3">
<h3 class="hasAnchor">
<a href="#pairwise-cladality-tests" class="anchor"></a>Pairwise cladality tests</h3>
</div>
<div id="rotating-outgroups" class="section level3">
<h3 class="hasAnchor">
<a href="#rotating-outgroups" class="anchor"></a>Rotating outgroups</h3>
<p><br></p>
</div>
</div>
<div id="qpgraph" class="section level2">
<h2 class="hasAnchor">
<a href="#qpgraph" class="anchor"></a>qpGraph</h2>
<p>Single f3- and f4-statistics can tell us how three or four populations are related to each other. qpGraph generalizes this concept to any number of populations. It takes estimated f3-statistics and the topology of an admixtgure graph, finds the edges weights that minimize the difference between fitted and estimated f3-statistics, and summarizes that difference in a likelihood score.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">qpg_results =<span class="st"> </span><span class="kw"><a href="../reference/qpgraph.html">qpgraph</a></span>(f2_dir, example_graph)</a></code></pre></div>
<p>Here, <code>example_graph</code> is a specific graph included in this R package, but you can provide any other graph in one of three formats.</p>
<ol style="list-style-type: decimal">
<li>An <a href="https://igraph.org/r/">igraph</a> object.</li>
<li>A two column matrix or data frame, where each row is an edge, the first column is the source of the edge, and the second column is the target. Additional columns labelled <code>lower</code> and <code>upper</code> can be used to constrain certain edges (<code>NA</code> = no constraint).</li>
<li>The location of a <code>qpGraph</code> graph file, which will be read and parsed.</li>
</ol>
<p>The leaf nodes of this graph have to match the f2-statistic population labels, and the graph has to be a valid admixture graph: a directed acyclic graph where each node has no more than two parents. If nodes with more than two children are present (polytomies or multifurcations) they will be split in a random order, and the new drift edges will be constrained to 0.</p>
<p><br></p>
<p>The output of <code>qpgraph</code> is a list with several items:</p>
<ul>
<li>
<strong>edges</strong>: A data frame with estimated edge weights. This includes normal edges as well as admixture edges.</li>
<li>
<strong>score</strong> The likelihood score. Smaller scores indicate a better fit.</li>
<li>
<strong>f2</strong> Estimated f2-statistics and standard errors for all population pairs</li>
<li>
<strong>f3</strong> Estimated and fitted f3-statistics for all population pairs with the outgroup. This includes residuals and Z-scores.</li>
<li>
<strong>opt</strong> A data frame with details from the weight optimization, with one row per set of starting values.</li>
<li>
<strong>ppinv</strong> The inverse of the f3-statistics covariance matrix</li>
</ul>
<p>Optionally, fitted and estimated f4-statistics can be returned by setting <code>return_f4 = TRUE</code>. When <code>f2_blocks_test</code> is provided, an out-of-sample score is computed and returned as <strong>score_test</strong>.</p>
<p>The fitted graph can be plotted like this:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="../reference/plot_graph.html">plot_graph</a></span>(qpg_results<span class="op">$</span>edges)</a></code></pre></div>
<p><img src="admixtools_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<p>or as an interactive plot:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw"><a href="../reference/plotly_graph.html">plotly_graph</a></span>(qpg_results<span class="op">$</span>edges)</a></code></pre></div>
<div id="htmlwidget-5899db88c5c28eedcaf2" style="width:700px;height:432.632880098888px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-5899db88c5c28eedcaf2">{"x":{"data":[{"x":[0,2],"y":[-1,-2],"text":"N3N5 -> N3N8","type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(216,144,0,1)","dash":"dot"},"hoveron":"points","name":"(admix,-1)","legendgroup":"(admix,-1)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-2,1],"y":[0,-1],"text":"N2N3 -> N2N4","type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(163,165,0,1)","dash":"dot"},"hoveron":"points","name":"(admix,0)","legendgroup":"(admix,0)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-1.5,0],"y":[1,0],"text":"N3N2 -> N3N4","type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(57,182,0,1)","dash":"dot"},"hoveron":"points","name":"(admix,1)","legendgroup":"(admix,1)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[0,0],"y":[2,0],"text":"N3N3 -> N3N4","type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(0,191,125,1)","dash":"dot"},"hoveron":"points","name":"(admix,2)","legendgroup":"(admix,2)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[1,1,null,2,2],"y":[3,-1,null,3,-2],"text":["N2N2 -> N2N4","N2N2 -> N2N4",null,"N3N7 -> N3N8","N3N7 -> N3N8"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)","dash":"dot"},"hoveron":"points","name":"(admix,3)","legendgroup":"(admix,3)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[2,2],"y":[-2,-3],"text":"N3N8 -> Russia_Ust_Ishim.DG","type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)","dash":"solid"},"hoveron":"points","name":"(normal,-2)","legendgroup":"(normal,-2)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[1,1],"y":[-1,-2],"text":"N2N4 -> Mbuti.DG","type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(216,144,0,1)","dash":"solid"},"hoveron":"points","name":"(normal,-1)","legendgroup":"(normal,-1)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[0,0],"y":[0,-1],"text":"N3N4 -> N3N5","type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(163,165,0,1)","dash":"solid"},"hoveron":"points","name":"(normal,0)","legendgroup":"(normal,0)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-2.5,-3,null,-2.5,-2],"y":[1,0,null,1,0],"text":["N2N1 -> Vindija.DG","N2N1 -> Vindija.DG",null,"N2N1 -> N2N3","N2N1 -> N2N3"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(57,182,0,1)","dash":"solid"},"hoveron":"points","name":"(normal,1)","legendgroup":"(normal,1)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-2,-2.5,null,-2,-1.5],"y":[2,1,null,2,1],"text":["N3N0 -> N2N1","N3N0 -> N2N1",null,"N3N0 -> N3N2","N3N0 -> N3N2"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(0,191,125,1)","dash":"solid"},"hoveron":"points","name":"(normal,2)","legendgroup":"(normal,2)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-2.5,-3,null,-2.5,-2,null,-0.5,-1,null,-0.5,0],"y":[3,2,null,3,2,null,3,2,null,3,2],"text":["N0N -> Altai_Neanderthal.DG","N0N -> Altai_Neanderthal.DG",null,"N0N -> N3N0","N0N -> N3N0",null,"N3N1 -> Denisova.DG","N3N1 -> Denisova.DG",null,"N3N1 -> N3N3","N3N1 -> N3N3"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)","dash":"solid"},"hoveron":"points","name":"(normal,3)","legendgroup":"(normal,3)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-1.5,-2.5,null,-1.5,-0.5,null,1.5,1,null,1.5,2],"y":[4,3,null,4,3,null,4,3,null,4,3],"text":["N1N -> N0N","N1N -> N0N",null,"N1N -> N3N1","N1N -> N3N1",null,"N3N6 -> N2N2","N3N6 -> N2N2",null,"N3N6 -> N3N7","N3N6 -> N3N7"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(0,176,246,1)","dash":"solid"},"hoveron":"points","name":"(normal,4)","legendgroup":"(normal,4)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[0,-1.5,null,0,1.5],"y":[5,4,null,5,4],"text":["N2N0 -> N1N","N2N0 -> N1N",null,"N2N0 -> N3N6","N2N0 -> N3N6"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(149,144,255,1)","dash":"solid"},"hoveron":"points","name":"(normal,5)","legendgroup":"(normal,5)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[0.5,0,null,0.5,1],"y":[6,5,null,6,5],"text":["N4N -> N2N0","N4N -> N2N0",null,"N4N -> Switzerland_Bichon.SG","N4N -> Switzerland_Bichon.SG"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(231,107,243,1)","dash":"solid"},"hoveron":"points","name":"(normal,6)","legendgroup":"(normal,6)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[0,-0.5,null,0,0.5],"y":[7,6,null,7,6],"text":["R -> Chimp.REF","R -> Chimp.REF",null,"R -> N4N","R -> N4N"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(255,98,188,1)","dash":"solid"},"hoveron":"points","name":"(normal,7)","legendgroup":"(normal,7)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-0.25,0.25,-2.75,-2.25,-2,-1,-0.75,0.75,-2.75,-2.25,1,-2.25,-1.75,-0.75,-0.25,0,1.25,1.75,2,0.25,0.75,1,-0.75,1,-0.5,0,2],"y":[6.5,6.5,2.5,2.5,3.5,3.5,4.5,4.5,0.5,0.5,-1.5,1.5,1.5,2.5,2.5,-0.5,3.5,3.5,-2.5,5.5,5.5,1,0.5,-1.5,-0.5,1,0.5],"text":["72","72","3","4","82","36","39","15","4","0","12","4","0","36","0","0","12","0","0","0","221","100%","0%","0%","0%","100%","100%"],"hovertext":["R -> Chimp.REF","R -> N4N","N0N -> Altai_Neanderthal.DG","N0N -> N3N0","N1N -> N0N","N1N -> N3N1","N2N0 -> N1N","N2N0 -> N3N6","N2N1 -> Vindija.DG","N2N1 -> N2N3","N2N4 -> Mbuti.DG","N3N0 -> N2N1","N3N0 -> N3N2","N3N1 -> Denisova.DG","N3N1 -> N3N3","N3N4 -> N3N5","N3N6 -> N2N2","N3N6 -> N3N7","N3N8 -> Russia_Ust_Ishim.DG","N4N -> N2N0","N4N -> Switzerland_Bichon.SG","N2N2 -> N2N4","N3N2 -> N3N4","N3N5 -> N3N8","N2N3 -> N2N4","N3N3 -> N3N4","N3N7 -> N3N8"],"textfont":{"size":9.4488188976378,"color":"rgba(0,0,0,1)"},"type":"scatter","mode":"text","hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[2],"y":[-3],"text":"Russia_Ust_Ishim.DG","hovertext":"","textfont":{"size":9.4488188976378,"color":"rgba(248,118,109,1)"},"type":"scatter","mode":"text","hoveron":"points","name":"(-2,1)","legendgroup":"(-2,1)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[1],"y":[-2],"text":"Mbuti.DG","hovertext":"","textfont":{"size":9.4488188976378,"color":"rgba(216,144,0,1)"},"type":"scatter","mode":"text","hoveron":"points","name":"(-1,1)","legendgroup":"(-1,1)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-3],"y":[0],"text":"Vindija.DG","hovertext":"","textfont":{"size":9.4488188976378,"color":"rgba(57,182,0,1)"},"type":"scatter","mode":"text","hoveron":"points","name":"1","legendgroup":"1","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-3,-1],"y":[2,2],"text":["Altai_Neanderthal.DG","Denisova.DG"],"hovertext":["",""],"textfont":{"size":9.4488188976378,"color":"rgba(0,191,196,1)"},"type":"scatter","mode":"text","hoveron":"points","name":"(3,1)","legendgroup":"(3,1)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[1],"y":[5],"text":"Switzerland_Bichon.SG","hovertext":"","textfont":{"size":9.4488188976378,"color":"rgba(231,107,243,1)"},"type":"scatter","mode":"text","hoveron":"points","name":"(6,1)","legendgroup":"(6,1)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-0.5],"y":[6],"text":"Chimp.REF","hovertext":"","textfont":{"size":9.4488188976378,"color":"rgba(255,98,188,1)"},"type":"scatter","mode":"text","hoveron":"points","name":"(7,1)","legendgroup":"(7,1)","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[0,-2.5,-1.5,0,-2.5,1,-2,-0.5,0,1.5,2,0.5,1,-1.5,0,-2,0,2],"y":[7,3,4,5,1,-1,2,3,0,4,-2,6,3,1,-1,0,2,3],"text":["R","N0N","N1N","N2N0","N2N1","N2N4","N3N0","N3N1","N3N4","N3N6","N3N8","N4N","N2N2","N3N2","N3N5","N2N3","N3N3","N3N7"],"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,0,0,1)","opacity":0,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,0,0,1)"}},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":27.8383223406054,"r":7.30593607305936,"b":15.4912903771351,"l":10.958904109589},"paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-3.6,2.6],"tickmode":"array","ticktext":["NA","-2","0","2"],"tickvals":[null,-2,4.44089209850063e-16,2],"categoryorder":"array","categoryarray":["NA","-2","0","2"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.65296803652968,"tickwidth":0,"showticklabels":false,"tickfont":{"color":null,"family":null,"size":0},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-3.5,7.5],"tickmode":"array","ticktext":["-2.5","0.0","2.5","5.0","7.5"],"tickvals":[-2.5,0,2.5,5,7.5],"categoryorder":"array","categoryarray":["-2.5","0.0","2.5","5.0","7.5"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.65296803652968,"tickwidth":0,"showticklabels":false,"tickfont":{"color":null,"family":null,"size":0},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":false,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","showSendToCloud":false},"source":"A","attrs":{"1220a2dff5190":{"linetype":{},"colour":{},"text":{},"x":{},"y":{},"xend":{},"yend":{},"from":{},"to":{},"type":"scatter"},"1220a5543dc87":{"x":{},"y":{},"label":{},"text":{},"x.1":{},"y.1":{},"xend":{},"yend":{},"from":{},"to":{}},"1220a5a434ecc":{"label":{},"colour":{},"from":{},"x":{},"y":{},"xend":{},"yend":{},"from.1":{},"to":{}},"1220a78ea615f":{"x":{},"y":{},"text":{},"x.1":{},"y.1":{},"xend":{},"yend":{},"from":{},"to":{}}},"cur_data":"1220a2dff5190","visdat":{"1220a2dff5190":["function (y) ","x"],"1220a5543dc87":["function (y) ","x"],"1220a5a434ecc":["function (y) ","x"],"1220a78ea615f":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script><p><br></p>
<div id="regularization-terms" class="section level3">
<h3 class="hasAnchor">
<a href="#regularization-terms" class="anchor"></a>Regularization terms</h3>
<p>There are two regularization terms (fudge factors) used in qpGraph. One is added to the diagonal elements of the f3 covariance matrix (after multiplying it by the mean of the diagonal elements), to ensure that the matrix inversion is stable. It is called <code>fudge_cov</code> and defaults to 10<sup>-5</sup>. Increasing this factor has a small effect on admixture weights and branch lengths, but a larger effect on the likelihood scores. The other regularization terms is added to the covariance matrix of fitted branch lengths (after scaling as before). It is called <code>fudge</code> and defaults to 10<sup>-4</sup>. In the original <em>qpGraph</em> program, this parameter can be set through the <code>diag</code> parameter.</p>
</div>
<div id="graph-optimization" class="section level3">
<h3 class="hasAnchor">
<a href="#graph-optimization" class="anchor"></a>Graph optimization</h3>
</div>
<div id="similar-graphs" class="section level3">
<h3 class="hasAnchor">
<a href="#similar-graphs" class="anchor"></a>Similar graphs</h3>
</div>
<div id="constraints" class="section level3">
<h3 class="hasAnchor">
<a href="#constraints" class="anchor"></a>Constraints</h3>
<p><br></p>
</div>
</div>
<div id="comparing-results-to-admixtools" class="section level2">
<h2 class="hasAnchor">
<a href="#comparing-results-to-admixtools" class="anchor"></a>Comparing results to AdmixTools</h2>
<p>There are wrapper function which call the origial <code>AdmixTools</code> programs and read the results. This can be used to check if the results of <code>qpgraph</code> are correct.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">binpath =<span class="st"> '/home/np29/o2bin/'</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2">env =<span class="st"> 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/n/app/openblas/0.2.19/lib/:/n/app/gsl/2.3/lib/;'</span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"></a>
<a class="sourceLine" id="cb27-4" data-line-number="4">qp3pop_bin  =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(env, binpath, <span class="st">'qp3pop'</span>)</a>
<a class="sourceLine" id="cb27-5" data-line-number="5">qpdstat_bin =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(env, binpath, <span class="st">'qpDstat'</span>)</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">qpadm_bin   =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(env, binpath, <span class="st">'qpAdm'</span>)</a>
<a class="sourceLine" id="cb27-7" data-line-number="7">qpgraph_bin =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(env, binpath, <span class="st">'qpGraph'</span>)</a>
<a class="sourceLine" id="cb27-8" data-line-number="8"></a>
<a class="sourceLine" id="cb27-9" data-line-number="9"><span class="co">#prefix = '/n/groups/reich/DAVID/V42/V42.1/v42.1'</span></a>
<a class="sourceLine" id="cb27-10" data-line-number="10">prefix =<span class="st"> '/n/groups/reich/robert/projects/admixprograms/v42.1_small'</span></a>
<a class="sourceLine" id="cb27-11" data-line-number="11">outdir =<span class="st"> 'write/files/here/'</span></a>
<a class="sourceLine" id="cb27-12" data-line-number="12"></a>
<a class="sourceLine" id="cb27-13" data-line-number="13"><span class="kw"><a href="../reference/qp3pop_wrapper.html">qp3pop_wrapper</a></span>(<span class="dt">source1 =</span> pop2, <span class="dt">source2 =</span> pop3, <span class="dt">target =</span> pop1,</a>
<a class="sourceLine" id="cb27-14" data-line-number="14">               qp3pop_bin, prefix, outdir)</a>
<a class="sourceLine" id="cb27-15" data-line-number="15"><span class="kw"><a href="../reference/qpdstat_wrapper.html">qpdstat_wrapper</a></span>(pop1, pop2, pop3, pop4,</a>
<a class="sourceLine" id="cb27-16" data-line-number="16">                qpdstat_bin, prefix, outdir)</a>
<a class="sourceLine" id="cb27-17" data-line-number="17"><span class="kw"><a href="../reference/qpadm_wrapper.html">qpadm_wrapper</a></span>(left, right, target,</a>
<a class="sourceLine" id="cb27-18" data-line-number="18">              qpadm_bin, prefix, outdir)</a>
<a class="sourceLine" id="cb27-19" data-line-number="19"><span class="kw"><a href="../reference/qpgraph_wrapper.html">qpgraph_wrapper</a></span>(example_graph,</a>
<a class="sourceLine" id="cb27-20" data-line-number="20">                qpgraph_bin, prefix, outdir)</a></code></pre></div>
<p><strong>Unless <code>outdir</code> is specified, calling these wrapper functions may overwrite files in the working directory!</strong></p>
<p>If you already have existing parameter files and population or graph files, you can run the wrapper functions like this (though the different programs will require different parfiles and popfiles):</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw"><a href="../reference/qp3pop_wrapper.html">qp3pop_wrapper</a></span> (<span class="dt">parfile =</span> <span class="st">'parfile.txt'</span>, <span class="dt">bin =</span> qp3pop_bin)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="kw"><a href="../reference/qpdstat_wrapper.html">qpdstat_wrapper</a></span>(<span class="dt">parfile =</span> <span class="st">'parfile.txt'</span>, <span class="dt">bin =</span> qpdstat_bin)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3"><span class="kw"><a href="../reference/qpadm_wrapper.html">qpadm_wrapper</a></span>  (<span class="dt">parfile =</span> <span class="st">'parfile.txt'</span>, <span class="dt">bin =</span> qpadm_bin)</a>
<a class="sourceLine" id="cb28-4" data-line-number="4"></a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="kw"><a href="../reference/qp3pop_wrapper.html">qp3pop_wrapper</a></span> (<span class="st">'popfile.txt'</span>, <span class="dt">bin =</span> qp3pop_bin,  <span class="dt">pref =</span> prefix)</a>
<a class="sourceLine" id="cb28-6" data-line-number="6"><span class="kw"><a href="../reference/qpdstat_wrapper.html">qpdstat_wrapper</a></span>(<span class="st">'popfile.txt'</span>, <span class="dt">bin =</span> qpdstat_bin, <span class="dt">pref =</span> prefix)</a>
<a class="sourceLine" id="cb28-7" data-line-number="7"></a>
<a class="sourceLine" id="cb28-8" data-line-number="8"><span class="kw"><a href="../reference/qpadm_wrapper.html">qpadm_wrapper</a></span>(<span class="dt">left =</span> <span class="st">'left.txt'</span>, <span class="dt">right =</span> <span class="st">'right.txt'</span>, <span class="dt">bin =</span> qpadm_bin, <span class="dt">pref =</span> prefix)</a>
<a class="sourceLine" id="cb28-9" data-line-number="9"></a>
<a class="sourceLine" id="cb28-10" data-line-number="10"><span class="kw"><a href="../reference/qpgraph_wrapper.html">qpgraph_wrapper</a></span>(<span class="st">'graphfile.txt'</span>, <span class="dt">parfile =</span> <span class="st">'parfile.txt'</span>, <span class="dt">bin =</span> qpgraph_bin)</a></code></pre></div>
<p><br></p>
<p>The following function makes it easy to compare qpGraph or qpAdm results.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">qpgraph_ref_results =<span class="st"> </span><span class="kw"><a href="../reference/qpgraph_wrapper.html">qpgraph_wrapper</a></span>(example_graph, qpgraph_bin, prefix)</a></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw"><a href="../reference/plot_comparison.html">plot_comparison</a></span>(qpg_results, qpgraph_ref_results)</a></code></pre></div>
<p><img src="admixtools_files/figure-html/unnamed-chunk-30-1.png" width="700"><br></p>
</div>
<div id="model-robustness" class="section level2">
<h2 class="hasAnchor">
<a href="#model-robustness" class="anchor"></a>Model robustness</h2>
<p>One of the advantages of being able to evaluate models quickly is that it becomes easier to test their robustness. For each <code>qp</code> function, there is a function which tests robustness by resampling SNPs (<code>resample_snps</code>), and another function which tests robustness by resampling individuals (<code>resample_inds</code>).</p>
<div id="resampling-snps" class="section level3">
<h3 class="hasAnchor">
<a href="#resampling-snps" class="anchor"></a>Resampling SNPs</h3>
<p>The subsampling of SNPs in blocks (sepcifically block jackknife) is already used throughout all AdmixTools programs to compute standard erorrs. Here, the <code>resample_snps</code> functions generalize this approach in two ways. First, they evaluate and returns <em>all</em> model parameters for each set of resampled SNP blocks. Second, they provide the option to do bootstrap resampling (resampling blocks with replacement while keeping the total number of blocks fixed) rather than jackknife resampling (leaving one block out at a time). The advantage of bootstrap over jackknife resampling is that bootstrap resampling is less likely to underestimate the true variability in the presence of a few, large outliers. The disadvantage is that it is inherently stochastic and doesn’t give the same results each time. Bootstrapping also makes it necessary to evaluate the whole model a large number of times, while jackknifing can be much faster, at least when computing only simple statistics.</p>
<p>Note that the bootstrap and jackknife resampling distributions are on different scales: Bootstrap standard errors are the square root of the sampling variance, whereas jackknife standard errors are the square root of <strong>n times</strong> the sampling variance.</p>
<p>In following example, 1000 models with resampled SNP blocks are evaluated, and a histogram of the likelihood scores is plotted.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">snpres =<span class="st"> </span><span class="kw"><a href="../reference/resample_snps.html">qpgraph_resample_snps</a></span>(example_f2_blocks, <span class="dt">graph =</span> example_graph, <span class="dt">boot =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(snpres<span class="op">$</span>score, <span class="dv">100</span>)</a></code></pre></div>
</div>
<div id="resampling-individuals" class="section level3">
<h3 class="hasAnchor">
<a href="#resampling-individuals" class="anchor"></a>Resampling individuals</h3>
<p>We can also test how robust a model is to changes in the individuals that make up a population. The <code>resample_inds</code> functions evaluate every model that results from excluding one individual, for each individual in populations with at least two individuals.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">pops =<span class="st"> </span><span class="kw">get_leafnames</span>(example_igraph)[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="dv">5</span><span class="op">:</span><span class="dv">7</span>)]</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">indres =<span class="st"> </span><span class="kw"><a href="../reference/resample_inds.html">qpgraph_resample_inds</a></span>(my_counts_dir, <span class="dt">inds =</span> inds, <span class="dt">pops =</span> pops, <span class="dt">graph =</span> example_graph)</a>
<a class="sourceLine" id="cb32-3" data-line-number="3"><span class="kw">ggplot</span>(indres, <span class="kw">aes</span>(score, score)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> ind))</a></code></pre></div>
<p>For populations with many individuals, this can be used to compute jackknife standard errors for statistics of that population.</p>
<p><br></p>
</div>
</div>
<div id="finding-graphs-with-good-fits" class="section level2">
<h2 class="hasAnchor">
<a href="#finding-graphs-with-good-fits" class="anchor"></a>Finding graphs with good fits</h2>
<p>Another advantage of being able to quickly evaluate a single model using precomputed f-statistics is that we can evaluate many different graphs in order to find graph topologies with good fits.</p>
<p><br></p>
<p>The function <code>find_graphs</code> generates and evaluates <code>numgraphs</code> admixture graphs in <code>numgen</code> iterations across <code>numrep</code> independent repeats to find well fitting admixture graphs.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">opt_results =<span class="st"> </span><span class="kw"><a href="../reference/find_graphs.html">find_graphs</a></span>(my_f2_dir, pops, <span class="dt">outpop =</span> pops[<span class="dv">1</span>], <span class="dt">numrep =</span> <span class="dv">200</span>,</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">                          <span class="dt">numgraphs =</span> <span class="dv">100</span>, <span class="dt">numgen =</span> <span class="dv">20</span>, <span class="dt">numsel =</span> <span class="dv">5</span>, <span class="dt">numadmix =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><br></p>
<p>Once that is done, the following commands will extract the best fitting model overall, and the best fitting model from each independent repeat.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">winner =<span class="st"> </span>opt_results <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">top_n</span>(<span class="dv">1</span>, <span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/jitter.html">jitter</a></span>(score))</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">winners =<span class="st"> </span>opt_results <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(run) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">top_n</span>(<span class="dv">1</span>, <span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/jitter.html">jitter</a></span>(score)) <span class="op">%&gt;%</span><span class="st"> </span>ungroup</a></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">winner<span class="op">$</span>score[[<span class="dv">1</span>]]</a></code></pre></div>
<pre><code>## [1] 4.009599</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw"><a href="../reference/plot_graph.html">plot_graph</a></span>(winner<span class="op">$</span>edges[[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="admixtools_files/figure-html/unnamed-chunk-36-1.png" width="864" style="display: block; margin: auto;"><br></p>
<div id="parallelization" class="section level3">
<h3 class="hasAnchor">
<a href="#parallelization" class="anchor"></a>Parallelization</h3>
<p>Depending on the input parameters, <code>find_graphs</code> can take a long time to run. With the parameters above, 420,000 admixture graphs (200 * 100 * (20+1)) will be generated and evaluated. Thanks to the function <a href="https://www.rdocumentation.org/packages/furrr/versions/0.1.0/topics/future_map">future_map</a> from the <a href="https://github.com/DavisVaughan/furrr">furrr</a> package, this can be sped up by parallelizing across the independent repeats. The function <a href="https://www.rdocumentation.org/packages/future/versions/1.15.1/topics/plan"><code><a href="https://rdrr.io/pkg/future/man/plan.html">future::plan</a></code></a> can be called to specify the details of the parallelization. This can be used to parallelize across CPU cores or across nodes on a compute cluster.</p>
<p>Setting it up like this will make it run multithreaded:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">future<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span>(<span class="st">'multiprocess'</span>)</a></code></pre></div>
<p><br></p>
<p>On the O2 cluster, the following command will set up parallelization across compute nodes.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">future<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span>(<span class="kw">tweak</span>(batchtools_slurm, <span class="dt">workers =</span> <span class="dv">50</span>,</a>
<a class="sourceLine" id="cb39-2" data-line-number="2">                   <span class="dt">resources=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">ncpus =</span> <span class="dv">1</span>, <span class="dt">memory =</span> <span class="dv">1024</span>,</a>
<a class="sourceLine" id="cb39-3" data-line-number="3">                                  <span class="dt">walltime =</span> <span class="dv">10</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>, <span class="dt">partition =</span> <span class="st">'short'</span>)))</a></code></pre></div>
<p>This specifies that up to 50 jobs should be run at a time, with each one requesting one CPU, 1024 MB of memory, and 10 hours on the <code>short</code> partition.</p>
<p>This requires the R package <code>future.batchtools</code> and a batchtools template file in the working directory, such as this one: <code>/n/groups/reich/robert/projects/admixprograms/batchtools.slurm.tmpl</code>.</p>
<p>With this setup the <code>find_graphs</code> function will submit each of the 200 repeats as a separate job.</p>
<p>As it will still take a while for this to finish, it is a good idea to submit this as one job which calls an R script. That R script will in turn spawn 200 new jobs and wait for them to finish and return their results.</p>
<p>The R script could look like this.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(admixtools)</a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(future.batchtools)</a>
<a class="sourceLine" id="cb40-3" data-line-number="3"></a>
<a class="sourceLine" id="cb40-4" data-line-number="4">future<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span>(<span class="kw">tweak</span>(batchtools_slurm, <span class="dt">workers=</span><span class="dv">50</span>,</a>
<a class="sourceLine" id="cb40-5" data-line-number="5">                   <span class="dt">resources=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">ncpus =</span> <span class="dv">1</span>, <span class="dt">memory=</span><span class="dv">1024</span>,</a>
<a class="sourceLine" id="cb40-6" data-line-number="6">                                  <span class="dt">walltime=</span><span class="dv">10</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>, <span class="dt">partition=</span><span class="st">'short'</span>)))</a>
<a class="sourceLine" id="cb40-7" data-line-number="7"></a>
<a class="sourceLine" id="cb40-8" data-line-number="8">pops =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'popA'</span>, <span class="st">'popB'</span>, <span class="st">'popC'</span>, <span class="st">'popD'</span>)</a>
<a class="sourceLine" id="cb40-9" data-line-number="9">opt_results =<span class="st"> </span><span class="kw"><a href="../reference/find_graphs.html">find_graphs</a></span>(<span class="st">'/my/f2/dir/'</span>, pops, <span class="dt">outpop =</span> pops[<span class="dv">1</span>], <span class="dt">numrep =</span> <span class="dv">200</span>,</a>
<a class="sourceLine" id="cb40-10" data-line-number="10">                          <span class="dt">numgen =</span> <span class="dv">20</span>, <span class="dt">numgraphs =</span> <span class="dv">100</span>, <span class="dt">numadmix =</span> <span class="dv">3</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb40-11" data-line-number="11"></a>
<a class="sourceLine" id="cb40-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/base/save.html">save</a></span>(opt_results, <span class="dt">file=</span><span class="st">'opt_results.RData'</span>)</a></code></pre></div>
<p>It could be in a file called <code>opt_graphs.Rscript</code> and be run like this, or submitted as a job.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">Rscript opt_graphs.Rscript</a></code></pre></div>
<p>It takes more time to evaluate larger graphs, and in particular graphs with more admixture nodes. It’s probably a good idea to start with a small number of repeats, generations, and graphs per generation to get a sense of the runtime before scaling it up.</p>
<p><br></p>
</div>
</div>
<div id="summarizing-graphs" class="section level2">
<h2 class="hasAnchor">
<a href="#summarizing-graphs" class="anchor"></a>Summarizing graphs</h2>
<p><br></p>
<blockquote>
<p><em>All models are wrong, but some are useful.</em> — George Box</p>
</blockquote>
<p><br></p>
<blockquote>
<p><em>All good models are alike; each bad model is bad in its own way.</em> — Leo Tolstoy</p>
</blockquote>
<p><br></p>
<p>For any set of populations there may be many graphs which can explain the data about equally well. Rather than declaring one of these models as the correct model, it may be more useful to find features that are shared between all models with good fits. The following function attempts to find such features by summarizing a set of graphs. It counts how often each population triple occurs in which configuration across all graphs.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">triples =<span class="st"> </span><span class="kw"><a href="../reference/summarize_triples.html">summarize_triples</a></span>(winners)</a></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1">triples <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="op">-</span>clade) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">1</span>)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 14
##   name1 name2 name3 numgraphs   x13   x23   x31   x32 clade   x12   x21 toptopo
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  
## 1 Russ… Swit… Deni…       200 0.005 0.245 0.505  0.38 0.345  0.88 0.505 011111 
## # … with 2 more variables: toptopocnt &lt;int&gt;, topos &lt;list&gt;</code></pre>
<p>The output for this population triple (1: <code>Rus</code>, 2: <code>Swi</code>, 3: <code>Den</code>) can be read like this:</p>
<ul>
<li>
<code>numgraphs</code>: 200 graphs were compared</li>
<li>
<code>clade</code>: In 34.5% of all graphs <code>Rus</code> and <code>Swi</code> form a clade with respect to <code>Den</code>
</li>
<li>
<code>x13</code>: In 0.5% of all graphs <code>Rus</code> is closer to <code>Den</code> than <code>Swi</code> is to <code>Den</code>, with ancestors of <code>Rus</code> admixing into <code>Den</code>
</li>
<li>
<code>x31</code>: In 50.5% of all graphs <code>Rus</code> is closer to <code>Den</code> than <code>Swi</code> is to <code>Den</code>, with ancestors of <code>Den</code> admixing into <code>Rus</code>
</li>
<li>
<code>x23</code>: In 24.5% of all graphs <code>Swi</code> is closer to <code>Den</code> than <code>Rus</code> is to <code>Den</code>, with ancestors of <code>Swi</code> admixing into <code>Den</code>
</li>
<li>
<code>x32</code>: In 38.0% of all graphs <code>Swi</code> is closer to <code>Den</code> than <code>Rus</code> is to <code>Den</code>, with ancestors of <code>Den</code> admixing into <code>Swi</code>
</li>
<li>
<code>toptopo</code>: The most common topology for this triple across all graphs. <code>011111</code> specifies a topology where condition <code>x13</code> is not satisfied, but conditions <code>x23</code>, <code>x31</code>, <code>x32</code>, <code>x12</code>, and <code>x21</code> are satisfied. A topology starting with <code>0000</code> is one where the first two populations form a clade.</li>
<li>
<code>toptopocnt</code>: The number of times <code>toptopo</code> was observed</li>
<li>
<code>topos</code>: The number of times each topology was observed</li>
</ul>
<p><br></p>
</div>
<div id="finding-valid-qpadm-models" class="section level2">
<h2 class="hasAnchor">
<a href="#finding-valid-qpadm-models" class="anchor"></a>Finding valid qpAdm models</h2>
<p>Every admixture graph maps to a specific set of valid qpAdm models. The function <code>qpadm_models</code> lists all valid qpAdm models for a graph. Models which are contained within larger valid models are not shown. The number of valid qpAdm models can be very large for big graphs, so you should only run this on small graphs.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1">mygraph =<span class="st"> </span>winners <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">6</span>) <span class="op">%$%</span><span class="st"> </span>igraph <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pluck</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb45-2" data-line-number="2"><span class="kw"><a href="../reference/plot_graph.html">plot_graph</a></span>(mygraph)</a></code></pre></div>
<p><img src="admixtools_files/figure-html/unnamed-chunk-44-1.png" width="864" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="kw"><a href="../reference/qpadm_models.html">qpadm_models</a></span>(mygraph, <span class="dt">add_outgroup =</span> <span class="ot">TRUE</span>, <span class="dt">nested =</span> <span class="ot">FALSE</span>, <span class="dt">abbr =</span> <span class="dv">3</span>)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   target left    right      
##   &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;      
## 1 Den    Alt,Mbu Chi,Rus,Swi
## 2 Den    Alt,Vin Chi,Rus,Swi
## 3 Den    Mbu,Vin Chi,Rus,Swi</code></pre>
<p>The only qpAdm models which are valid under this graph have <code>Den</code> as target and <code>Chi</code>, <code>Rus</code>, and <code>Swi</code> as right populations.</p>
<p>Valid qpAdm models need to satisfy the following criteria:</p>
<ul>
<li>There have to be more right populations than left populations</li>
<li>The left populations should not form a clade with respect to any right population. This means that a qpgraph outgroup is not an informative right population, but it can be included anyway, with <code>add_outgroup</code>.</li>
<li>Each set of left populations which forms a source for the target population has to form a clade with target at the exclusion of each right population. (Note: Check if that’s correct and if it can be stated in a better way.)</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#f-statistics"><em>f</em>-statistics</a></li>
      <li><a href="#qp3pop">qp3Pop</a></li>
      <li><a href="#qpdstat">qpDstat</a></li>
      <li><a href="#qpwave-and-qpadm">qpWave and qpAdm</a></li>
      <li><a href="#qpgraph">qpGraph</a></li>
      <li><a href="#comparing-results-to-admixtools">Comparing results to AdmixTools</a></li>
      <li><a href="#model-robustness">Model robustness</a></li>
      <li><a href="#finding-graphs-with-good-fits">Finding graphs with good fits</a></li>
      <li><a href="#summarizing-graphs">Summarizing graphs</a></li>
      <li><a href="#finding-valid-qpadm-models">Finding valid qpAdm models</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Robert Maier, Nick Patterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '',
    indexName: 'admixtools',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
